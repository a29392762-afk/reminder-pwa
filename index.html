<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>å¤šåŠŸèƒ½æé†’</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#EC4899" />

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Rubik','Noto Sans TC',sans-serif; background:#E8E0D5; }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">
<div id="app" class="w-full max-w-2xl">
  <div class="bg-white rounded-3xl shadow-2xl p-6">

    <div class="flex items-center justify-between gap-3 mb-4">
      <h1 class="text-3xl font-black text-pink-600">ğŸ”” å¤šåŠŸèƒ½æé†’</h1>
      <button @click="resetAll" class="px-4 py-2 rounded-xl bg-gray-200 font-bold">æ¸…ç©ºå…¨éƒ¨</button>
    </div>

    <!-- å•Ÿç”¨é€šçŸ¥ï¼šå·²å•Ÿç”¨å°±æ•´å¡Šä¸é¡¯ç¤º -->
    <div v-if="showEnablePush" class="mb-6">
      <button @click="enablePush"
        class="w-full py-4 rounded-2xl font-black bg-pink-600 text-white">
        å•Ÿç”¨é€šçŸ¥
      </button>
      <p class="text-xs text-gray-600 mt-2 leading-relaxed">
        å°æé†’ï¼šè‹¥ä½ è¦å•Ÿç”¨é€šçŸ¥ï¼Œè«‹å…ˆç”¨ Safari æ‰“é–‹ç¶²ç«™ â†’ åˆ†äº« â†’ã€ŒåŠ å…¥ä¸»ç•«é¢ã€â†’ å¾ä¸»ç•«é¢åœ–ç¤ºé–‹å•Ÿå¾Œå†æŒ‰æ­¤æŒ‰éˆ•ã€‚
      </p>
    </div>

    <!-- æ–°å¢æé†’ -->
    <div class="bg-white rounded-2xl border p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
        <div class="md:col-span-2">
          <label class="block text-sm font-bold mb-1">æé†’åç¨±</label>
          <input v-model.trim="draft.title" class="w-full border rounded-xl p-3"
                 placeholder="ä¾‹å¦‚ï¼šéš±å½¢çœ¼é¡ / æ¿¾èŠ¯ / ä¿é¤Š" />
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-bold mb-1">é–‹å§‹ä½¿ç”¨æ—¥æœŸ</label>
          <!-- iOS ä¸Šä¸ç”¨ type=dateï¼Œé¿å…æ€ªç°æ¢/çˆ†æ¡† -->
          <input
            type="text"
            v-model.trim="draft.startDate"
            inputmode="numeric"
            placeholder="YYYY-MM-DD æˆ– YYYYMMDD"
            class="w-full border rounded-xl p-3"
          />
          <p class="text-xs text-gray-500 mt-1">ä¾‹ï¼š2025-12-24 æˆ– 20251224</p>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-bold mb-1">ä½¿ç”¨å¤©æ•¸</label>
          <input type="number" min="1" v-model.number="draft.useDays" class="w-full border rounded-xl p-3" />
        </div>
      </div>

      <div class="mt-4 rounded-xl bg-gray-50 border p-3 text-sm text-gray-700 font-bold"
           v-if="previewDueDate">
        é è¨ˆåˆ°æœŸæ—¥ï¼š<span class="text-pink-600 font-black text-base">{{ previewDueDate }}</span>
      </div>

      <div class="flex gap-3 mt-4">
        <button @click="addReminder"
          class="flex-1 bg-pink-600 text-white font-black rounded-xl py-3">
          ï¼‹ æ–°å¢æé†’
        </button>
        <button @click="refresh"
          class="flex-1 bg-gray-200 font-bold rounded-xl py-3">
          é‡æ–°æ•´ç†æ¸…å–®
        </button>
      </div>
    </div>

    <!-- æœå°‹ + æ’åºï¼ˆæ‰‹æ©Ÿå…©è¡Œï¼Œä¸æœƒè¶…å‡ºï¼‰ -->
    <div class="mb-3 grid grid-cols-1 md:grid-cols-[1fr_auto] gap-2">
      <input v-model.trim="keyword" placeholder="æœå°‹â€¦" class="w-full border rounded-xl p-3" />
      <select v-model="sortBy" class="w-full md:w-auto border rounded-xl p-3 font-bold">
        <option value="dueAsc">åˆ°æœŸï¼šè¿‘â†’é </option>
        <option value="dueDesc">åˆ°æœŸï¼šé â†’è¿‘</option>
      </select>
    </div>

    <div v-if="filtered.length === 0" class="text-center text-gray-500 font-bold py-10">
      ç›®å‰æ²’æœ‰æé†’ ğŸ™‚
    </div>

    <div class="space-y-3">
      <div v-for="r in filtered" :key="r.id"
        class="rounded-2xl border p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3"
        :class="cardClass(r)">

        <div class="flex-1 min-w-0">
          <div class="text-xl font-black text-gray-800 break-words">{{ r.title }}</div>

          <div class="mt-2 text-sm font-bold text-gray-700 leading-relaxed space-y-1">
            <div class="flex flex-wrap gap-x-4 gap-y-1">
              <span class="whitespace-nowrap">é–‹å§‹æ—¥ï¼š{{ formatDate(r.startDate) }}</span>
              <span class="whitespace-nowrap">ä½¿ç”¨ï¼š{{ r.useDays }} å¤©</span>
            </div>

            <div class="flex flex-wrap items-center gap-x-3 gap-y-1">
              <span class="whitespace-nowrap">åˆ°æœŸæ—¥ï¼š{{ formatDate(r.dueDate) }}</span>
              <span class="text-xs font-black px-2 py-1 rounded-full" :class="badgeClass(r)">
                {{ badgeText(r) }}
              </span>
            </div>

            <div class="text-gray-500 font-bold">
              å‰©é¤˜ï¼š<b class="text-gray-700">{{ daysLeft(r) }}</b> å¤©
            </div>
          </div>
        </div>

        <div class="flex gap-2">
          <button @click="del(r.id)" class="px-4 py-2 rounded-xl bg-gray-200 font-bold">åˆªé™¤</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}

// âœ… å…è¨± YYYY-MM-DD æˆ– YYYYMMDDï¼Œå…¶ä»–æ ¼å¼å›å‚³ç©ºå­—ä¸²
function normalizeDate(input) {
  if (!input) return '';
  const s = String(input).trim();

  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  if (/^\d{8}$/.test(s)) return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
  return '';
}

createApp({
  setup() {
    const reminders = ref([]);
    const keyword = ref('');
    const sortBy = ref('dueAsc');

    const draft = ref({ title: '', startDate: '', useDays: 14 });

    const isStandalone = ref(false);
    const pushSupported = ref(false);
    const notificationGranted = ref(false);

    const today0 = () => { const d=new Date(); d.setHours(0,0,0,0); return d; };
    const toDate0 = (s) => { const d=new Date(s); d.setHours(0,0,0,0); return d; };

    const addDaysToYMD = (ymd, days) => {
      const d = toDate0(ymd);
      if (Number.isNaN(d.getTime())) return ''; // é˜²å‘†
      d.setDate(d.getDate() + Number(days));
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    };

    const previewDueDate = computed(() => {
      const normalized = normalizeDate(draft.value.startDate);
      if (!normalized || !draft.value.useDays) return '';
      return addDaysToYMD(normalized, draft.value.useDays);
    });

    const formatDate = (s) => s ? new Date(s).toLocaleDateString('zh-TW') : '';
    const daysLeft = (r) => Math.ceil((toDate0(r.dueDate) - today0()) / 86400000);

    const status = (r) => {
      const dl = daysLeft(r);
      if (dl < 0) return 'overdue';
      if (dl === 0) return 'due';
      if (dl <= 2) return 'soon';
      return 'ok';
    };

    const badgeText = (r) => ({ overdue:'å·²é€¾æœŸ', due:'ä»Šå¤©åˆ°æœŸ', soon:'å¿«åˆ°äº†', ok:'æ­£å¸¸' }[status(r)]);
    const badgeClass = (r) => ({
      overdue:'bg-red-600 text-white',
      due:'bg-red-500 text-white',
      soon:'bg-amber-400 text-stone-900',
      ok:'bg-emerald-200 text-emerald-800'
    }[status(r)]);
    const cardClass = (r) => ({
      overdue:'border-red-200 bg-red-50',
      due:'border-red-200 bg-red-50',
      soon:'border-amber-200 bg-amber-50',
      ok:'border-gray-200 bg-white'
    }[status(r)]);

    const filtered = computed(() => {
      let list = [...reminders.value];
      if (keyword.value) {
        const k = keyword.value.toLowerCase();
        list = list.filter(r => (r.title||'').toLowerCase().includes(k));
      }
      const byDue = (a,b) => toDate0(a.dueDate) - toDate0(b.dueDate);
      list.sort(sortBy.value === 'dueAsc' ? byDue : (a,b)=>-byDue(a,b));
      return list;
    });

    // âœ… å·²å•Ÿç”¨é€šçŸ¥å°±ä¸è¦é¡¯ç¤ºé‚£å¡Š
    const showEnablePush = computed(() => {
      if (!pushSupported.value) return false;
      if (!isStandalone.value) return true;
      return !notificationGranted.value;
    });

    async function refresh() {
      const res = await fetch('/.netlify/functions/listReminders', { cache:'no-store' });
      const text = await res.text();
      if (!res.ok) throw new Error(`listReminders ${res.status}: ${text}`);
      const data = JSON.parse(text);
      reminders.value = data.reminders || [];
    }

    async function addReminder() {
      try {
        if (!draft.value.title) return alert('è«‹è¼¸å…¥æé†’åç¨±');

        const normalizedDate = normalizeDate(draft.value.startDate);
        if (!normalizedDate) return alert('æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼Œè«‹ç”¨ YYYY-MM-DD æˆ– YYYYMMDD');

        if (!draft.value.useDays || Number(draft.value.useDays) <= 0) return alert('ä½¿ç”¨å¤©æ•¸è‡³å°‘ 1 å¤©');

        const dueDate = addDaysToYMD(normalizedDate, draft.value.useDays);
        if (!dueDate) return alert('æ—¥æœŸè§£æå¤±æ•—ï¼Œè«‹æª¢æŸ¥é–‹å§‹ä½¿ç”¨æ—¥æœŸ');

        const res = await fetch('/.netlify/functions/addReminder', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            title: draft.value.title,
            startDate: normalizedDate,
            useDays: Number(draft.value.useDays),
            dueDate
          })
        });

        const text = await res.text();
        if (!res.ok) return alert(`æ–°å¢å¤±æ•—ï¼š${res.status}\n${text}`);

        draft.value = { title:'', startDate:'', useDays:14 };
        await refresh();
      } catch (e) {
        alert(`æ–°å¢å¤±æ•—ï¼š${String(e)}`);
      }
    }

    async function del(id) {
      try {
        const res = await fetch('/.netlify/functions/deleteReminder', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id })
        });
        const text = await res.text();
        if (!res.ok) return alert(`åˆªé™¤å¤±æ•—ï¼š${res.status}\n${text}`);
        await refresh();
      } catch (e) {
        alert(`åˆªé™¤å¤±æ•—ï¼š${String(e)}`);
      }
    }

    async function enablePush() {
      const standalone =
        window.matchMedia('(display-mode: standalone)').matches ||
        window.navigator.standalone === true;

      if (!standalone) {
        alert('è«‹å…ˆã€ŒåŠ å…¥ä¸»ç•«é¢ã€ï¼Œä¸¦å¾ä¸»ç•«é¢åœ–ç¤ºæ‰“é–‹ï¼Œå†å•Ÿç”¨é€šçŸ¥');
        return;
      }

      if (!('serviceWorker' in navigator) || !('PushManager' in window) || !('Notification' in window)) {
        alert('æ­¤ç’°å¢ƒä¸æ”¯æ´æ¨æ’­ï¼ˆè«‹ç¢ºèªå·²åŠ å…¥ä¸»ç•«é¢ï¼Œä¸”ç¶²ç«™ç‚º HTTPSï¼‰');
        return;
      }

      const reg = await navigator.serviceWorker.register('/sw.js');

      const keyRes = await fetch('/.netlify/functions/vapidPublicKey', { cache:'no-store' });
      const keyText = await keyRes.text();
      if (!keyRes.ok) return alert(`å–å¾—æ¨æ’­é‡‘é‘°å¤±æ•—ï¼š${keyRes.status}\n${keyText}`);
      const { publicKey } = JSON.parse(keyText);

      const perm = await Notification.requestPermission();
      if (perm !== 'granted') {
        alert('ä½ æ²’æœ‰å…è¨±é€šçŸ¥ï¼Œç„¡æ³•å•Ÿç”¨');
        notificationGranted.value = false;
        return;
      }

      const sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(publicKey)
      });

      const saveRes = await fetch('/.netlify/functions/subscribe', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(sub)
      });

      const saveText = await saveRes.text();
      if (!saveRes.ok) return alert(`è¨‚é–±ä¿å­˜å¤±æ•—ï¼š${saveRes.status}\n${saveText}`);

      notificationGranted.value = true;
      alert('é€šçŸ¥å·²å•Ÿç”¨ âœ…');
    }

    async function resetAll() {
      if (!confirm('ç¢ºå®šæ¸…ç©ºå…¨éƒ¨æé†’ï¼Ÿï¼ˆä¼ºæœå™¨ç«¯ä¹Ÿæœƒæ¸…ç©ºï¼‰')) return;
      for (const r of reminders.value) await del(r.id);
      await refresh();
    }

    onMounted(async () => {
      isStandalone.value =
        window.matchMedia('(display-mode: standalone)').matches ||
        window.navigator.standalone === true;

      pushSupported.value =
        ('serviceWorker' in navigator) &&
        ('PushManager' in window) &&
        ('Notification' in window);

      notificationGranted.value =
        ('Notification' in window) && (Notification.permission === 'granted');

      if ('serviceWorker' in navigator) {
        try { await navigator.serviceWorker.register('/sw.js'); } catch {}
      }

      try { await refresh(); } catch (e) { console.error(e); }
    });

    return {
      reminders, keyword, sortBy, draft,
      previewDueDate,
      filtered,
      showEnablePush,
      enablePush,
      addReminder, refresh, del, resetAll,
      formatDate, daysLeft, badgeText, badgeClass, cardClass
    };
  }
}).mount('#app');
</script>
</body>
</html>

<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>å¤šåŠŸèƒ½æé†’</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#EC4899" />

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Rubik','Noto Sans TC',sans-serif; background:#E8E0D5; }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">
<div id="app" class="w-full max-w-2xl">
  <div class="bg-white rounded-3xl shadow-2xl p-6">

    <div class="flex items-center justify-between gap-3 mb-4">
      <h1 class="text-3xl font-black text-pink-600">ğŸ”” å¤šåŠŸèƒ½æé†’</h1>
      <button @click="resetAll" class="px-4 py-2 rounded-xl bg-gray-200 font-bold">æ¸…ç©ºå…¨éƒ¨</button>
    </div>

    <!-- æ¨æ’­ï¼šä¸é¡¯ç¤ºç‹€æ…‹ï¼Œåªä¿ç•™æŒ‰éˆ• -->
    <div class="mb-6">
      <button @click="enablePush"
        class="w-full px-4 py-3 rounded-2xl font-black bg-pink-600 text-white">
        å•Ÿç”¨é€šçŸ¥
      </button>
      <p class="text-xs text-gray-500 mt-2 leading-relaxed">
        å°æé†’ï¼šè‹¥ä½ è¦å•Ÿç”¨é€šçŸ¥ï¼Œè«‹å…ˆç”¨ Safari æ‰“é–‹ç¶²ç«™ â†’ åˆ†äº« â†’ã€ŒåŠ å…¥ä¸»ç•«é¢ã€â†’ å¾ä¸»ç•«é¢åœ–ç¤ºé–‹å•Ÿå¾Œå†æŒ‰æ­¤æŒ‰éˆ•ã€‚
      </p>
    </div>

    <!-- æ–°å¢æé†’ï¼šé–‹å§‹ä½¿ç”¨æ—¥æœŸ + ä½¿ç”¨å¤©æ•¸ -->
    <div class="bg-white rounded-2xl border p-4 mb-6">
      <div class="grid md:grid-cols-6 gap-3">
        <div class="md:col-span-2">
          <label class="block text-sm font-bold mb-1">æé†’åç¨±</label>
          <input v-model.trim="draft.title" class="w-full border rounded-xl p-3"
                 placeholder="ä¾‹å¦‚ï¼šéš±å½¢çœ¼é¡ / æ¿¾èŠ¯ / ä¿é¤Š" />
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-bold mb-1">é–‹å§‹ä½¿ç”¨æ—¥æœŸ</label>
          <input type="date" v-model="draft.startDate" class="w-full border rounded-xl p-3" />
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-bold mb-1">ä½¿ç”¨å¤©æ•¸</label>
          <input type="number" min="1" v-model.number="draft.useDays" class="w-full border rounded-xl p-3" />
        </div>
      </div>

      <div class="mt-4 rounded-xl bg-gray-50 border p-3 text-sm text-gray-700 font-bold"
           v-if="draft.startDate && draft.useDays">
        é è¨ˆåˆ°æœŸæ—¥ï¼š<span class="text-pink-600 font-black text-base">{{ previewDueDate }}</span>
      </div>

      <div class="flex gap-3 mt-4">
        <button @click="addReminder"
          class="flex-1 bg-pink-600 text-white font-black rounded-xl py-3">
          ï¼‹ æ–°å¢æé†’
        </button>
        <button @click="refresh"
          class="flex-1 bg-gray-200 font-bold rounded-xl py-3">
          é‡æ–°æ•´ç†æ¸…å–®
        </button>
      </div>
    </div>

    <!-- æ¸…å–® -->
    <div class="flex items-center gap-2 mb-3">
      <input v-model.trim="keyword" placeholder="æœå°‹â€¦" class="flex-1 border rounded-xl p-3" />
      <select v-model="sortBy" class="border rounded-xl p-3 font-bold">
        <option value="dueAsc">åˆ°æœŸæ—¥ï¼šè¿‘ â†’ é </option>
        <option value="dueDesc">åˆ°æœŸæ—¥ï¼šé  â†’ è¿‘</option>
      </select>
    </div>

    <div v-if="filtered.length === 0" class="text-center text-gray-500 font-bold py-10">
      ç›®å‰æ²’æœ‰æé†’ ğŸ™‚
    </div>

    <div class="space-y-3">
      <div v-for="r in filtered" :key="r.id"
        class="rounded-2xl border p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3"
        :class="cardClass(r)">

        <div class="flex-1">
          <div class="text-lg font-black text-gray-800">{{ r.title }}</div>

          <div class="text-sm mt-1 text-gray-700 font-bold">
            é–‹å§‹æ—¥ï¼š{{ formatDate(r.startDate) }}ã€€
            ä½¿ç”¨ï¼š{{ r.useDays }} å¤©ã€€
          </div>

          <div class="text-sm mt-1 text-gray-700 font-bold">
            åˆ°æœŸæ—¥ï¼š{{ formatDate(r.dueDate) }}
            <span class="ml-2 text-xs font-black px-2 py-1 rounded-full" :class="badgeClass(r)">
              {{ badgeText(r) }}
            </span>
          </div>

          <div class="text-sm text-gray-500 mt-1">
            å‰©é¤˜ï¼š<b>{{ daysLeft(r) }}</b> å¤©
          </div>
        </div>

        <div class="flex gap-2">
          <button @click="del(r.id)" class="px-4 py-2 rounded-xl bg-gray-200 font-bold">åˆªé™¤</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}

createApp({
  setup() {
    const reminders = ref([]);
    const keyword = ref('');
    const sortBy = ref('dueAsc');

    const draft = ref({ title: '', startDate: '', useDays: 14 });

    const today0 = () => { const d=new Date(); d.setHours(0,0,0,0); return d; };
    const toDate0 = (s) => { const d=new Date(s); d.setHours(0,0,0,0); return d; };

    const addDaysToYMD = (ymd, days) => {
      const d = toDate0(ymd);
      d.setDate(d.getDate() + Number(days));
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    };

    const previewDueDate = computed(() => {
      if (!draft.value.startDate || !draft.value.useDays) return '';
      return addDaysToYMD(draft.value.startDate, draft.value.useDays);
    });

    const formatDate = (s) => s ? new Date(s).toLocaleDateString('zh-TW') : '';
    const daysLeft = (r) => Math.ceil((toDate0(r.dueDate) - today0()) / 86400000);

    const status = (r) => {
      const dl = daysLeft(r);
      if (dl < 0) return 'overdue';
      if (dl === 0) return 'due';
      if (dl <= 2) return 'soon';
      return 'ok';
    };

    const badgeText = (r) => ({ overdue:'å·²é€¾æœŸ', due:'ä»Šå¤©åˆ°æœŸ', soon:'å¿«åˆ°äº†', ok:'æ­£å¸¸' }[status(r)]);
    const badgeClass = (r) => ({
      overdue:'bg-red-600 text-white',
      due:'bg-red-500 text-white',
      soon:'bg-amber-400 text-stone-900',
      ok:'bg-emerald-200 text-emerald-800'
    }[status(r)]);
    const cardClass = (r) => ({
      overdue:'border-red-200 bg-red-50',
      due:'border-red-200 bg-red-50',
      soon:'border-amber-200 bg-amber-50',
      ok:'border-gray-200 bg-white'
    }[status(r)]);

    const filtered = computed(() => {
      let list = [...reminders.value];
      if (keyword.value) {
        const k = keyword.value.toLowerCase();
        list = list.filter(r => (r.title||'').toLowerCase().includes(k));
      }
      const byDue = (a,b) => toDate0(a.dueDate) - toDate0(b.dueDate);
      list.sort(sortBy.value === 'dueAsc' ? byDue : (a,b)=>-byDue(a,b));
      return list;
    });

    async function refresh() {
      const res = await fetch('/.netlify/functions/listReminders', { cache:'no-store' });
      const text = await res.text();
      if (!res.ok) throw new Error(`listReminders ${res.status}: ${text}`);
      const data = JSON.parse(text);
      reminders.value = data.reminders || [];
    }

    async function addReminder() {
      try {
        if (!draft.value.title) return alert('è«‹è¼¸å…¥æé†’åç¨±');
        if (!draft.value.startDate) return alert('è«‹é¸é–‹å§‹ä½¿ç”¨æ—¥æœŸ');
        if (!draft.value.useDays || Number(draft.value.useDays) <= 0) return alert('ä½¿ç”¨å¤©æ•¸è‡³å°‘ 1 å¤©');

        const dueDate = addDaysToYMD(draft.value.startDate, draft.value.useDays);

        const res = await fetch('/.netlify/functions/addReminder', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            title: draft.value.title,
            startDate: draft.value.startDate,
            useDays: Number(draft.value.useDays),
            dueDate
          })
        });

        const text = await res.text();
        if (!res.ok) {
          console.error('addReminder failed:', res.status, text);
          alert(`æ–°å¢å¤±æ•—ï¼š${res.status}\n${text}`);
          return;
        }

        draft.value = { title:'', startDate:'', useDays:14 };
        await refresh();
      } catch (e) {
        console.error(e);
        alert(`æ–°å¢å¤±æ•—ï¼š${String(e)}`);
      }
    }

    async function del(id) {
      try {
        const res = await fetch('/.netlify/functions/deleteReminder', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id })
        });
        const text = await res.text();
        if (!res.ok) return alert(`åˆªé™¤å¤±æ•—ï¼š${res.status}\n${text}`);
        await refresh();
      } catch (e) {
        alert(`åˆªé™¤å¤±æ•—ï¼š${String(e)}`);
      }
    }

    async function enablePush() {
      const standalone =
        window.matchMedia('(display-mode: standalone)').matches ||
        window.navigator.standalone === true;

      if (!standalone) {
        alert('è«‹å…ˆã€ŒåŠ å…¥ä¸»ç•«é¢ã€ï¼Œä¸¦å¾ä¸»ç•«é¢åœ–ç¤ºæ‰“é–‹ï¼Œå†å•Ÿç”¨é€šçŸ¥');
        return;
      }
      if (!('serviceWorker' in navigator) || !('PushManager' in window) || !('Notification' in window)) {
        alert('æ­¤ç’°å¢ƒä¸æ”¯æ´æ¨æ’­ï¼ˆè«‹ç¢ºèªå·²åŠ å…¥ä¸»ç•«é¢ï¼Œä¸”ç¶²ç«™ç‚º HTTPSï¼‰');
        return;
      }

      const reg = await navigator.serviceWorker.register('/sw.js');

      const keyRes = await fetch('/.netlify/functions/vapidPublicKey', { cache:'no-store' });
      const keyText = await keyRes.text();
      if (!keyRes.ok) return alert(`å–å¾—æ¨æ’­é‡‘é‘°å¤±æ•—ï¼š${keyRes.status}\n${keyText}`);
      const { publicKey } = JSON.parse(keyText);

      const perm = await Notification.requestPermission();
      if (perm !== 'granted') {
        alert('ä½ æ²’æœ‰å…è¨±é€šçŸ¥ï¼Œç„¡æ³•å•Ÿç”¨');
        return;
      }

      const sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(publicKey)
      });

      const saveRes = await fetch('/.netlify/functions/subscribe', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(sub)
      });

      const saveText = await saveRes.text();
      if (!saveRes.ok) {
        alert(`è¨‚é–±ä¿å­˜å¤±æ•—ï¼š${saveRes.status}\n${saveText}`);
        return;
      }

      alert('é€šçŸ¥å·²å•Ÿç”¨ âœ…');
    }

    async function resetAll() {
      if (!confirm('ç¢ºå®šæ¸…ç©ºå…¨éƒ¨æé†’ï¼Ÿï¼ˆä¼ºæœå™¨ç«¯ä¹Ÿæœƒæ¸…ç©ºï¼‰')) return;
      for (const r of reminders.value) await del(r.id);
      await refresh();
    }

    onMounted(async () => {
      // é å…ˆè¨»å†Š SWï¼ˆè®“ iOS æ¯”è¼ƒç©©ï¼‰
      if ('serviceWorker' in navigator) {
        try { await navigator.serviceWorker.register('/sw.js'); } catch {}
      }
      try { await refresh(); } catch (e) { console.error(e); }
    });

    return {
      reminders, keyword, sortBy, draft,
      previewDueDate,
      filtered,
      enablePush,
      addReminder, refresh, del, resetAll,
      formatDate, daysLeft, badgeText, badgeClass, cardClass
    };
  }
}).mount('#app');
</script>
</body>
</html>
